<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>并行化执行时序图</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        h2 {
            color: #555;
            margin-top: 40px;
            border-left: 4px solid #2196F3;
            padding-left: 15px;
        }
        .diagram-container {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .mermaid {
            text-align: center;
        }
        .code-block {
            background: #f4f4f4;
            padding: 15px;
            border-radius: 5px;
            border-left: 4px solid #4CAF50;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>并行化执行时序图</h1>

    <div class="diagram-container">
        <div class="mermaid">
sequenceDiagram
    participant Main as main函数
    participant Config as 配置模块
    participant LLM as LLM模型
    participant SummarizeChain as 摘要链
    participant QuestionsChain as 问题链
    participant TermsChain as 术语链
    participant ParallelGraph as 并行图
    participant SynthesisChain as 综合链
    participant Output as 输出

    Main->>Config: 1. 读取 OPENAI_API_KEY
    Main->>Config: 2. 读取 OPENAI_BASE_URL (可选)
    Config-->>Main: 配置信息
    
    Main->>LLM: 3. 初始化模型(gpt-4o-mini)
    LLM-->>Main: 模型就绪
    
    Main->>SummarizeChain: 4. 构建摘要链
    SummarizeChain-->>Main: 链编译成功
    
    Main->>QuestionsChain: 5. 构建问题链
    QuestionsChain-->>Main: 链编译成功
    
    Main->>TermsChain: 6. 构建术语链
    TermsChain-->>Main: 链编译成功
    
    Main->>ParallelGraph: 7. 创建并行图
    Main->>ParallelGraph: 7.1 添加 summarize 节点
    Main->>ParallelGraph: 7.2 添加 questions 节点
    Main->>ParallelGraph: 7.3 添加 terms 节点
    Main->>ParallelGraph: 7.4 添加 topic 节点
    Main->>ParallelGraph: 7.5 配置并行边和触发模式
    ParallelGraph-->>Main: 图编译成功
    
    Main->>SynthesisChain: 8. 构建综合链
    SynthesisChain-->>Main: 链编译成功
    
    Note over Main: 输入主题: "太空探索的历史"
    
    Main->>ParallelGraph: 9. 执行并行图
    par 并行执行
        ParallelGraph->>SummarizeChain: 9.1 执行摘要链
        SummarizeChain->>LLM: 调用 LLM 生成摘要
        LLM-->>SummarizeChain: 返回摘要内容
        SummarizeChain-->>ParallelGraph: summary: "摘要文本"
    and
        ParallelGraph->>QuestionsChain: 9.2 执行问题链
        QuestionsChain->>LLM: 调用 LLM 生成问题
        LLM-->>QuestionsChain: 返回问题列表
        QuestionsChain-->>ParallelGraph: questions: "问题文本"
    and
        ParallelGraph->>TermsChain: 9.3 执行术语链
        TermsChain->>LLM: 调用 LLM 提取术语
        LLM-->>TermsChain: 返回关键术语
        TermsChain-->>ParallelGraph: key_terms: "术语列表"
    and
        ParallelGraph->>ParallelGraph: 9.4 传递原始主题
        ParallelGraph-->>ParallelGraph: topic: "太空探索的历史"
    end
    
    Note over ParallelGraph: 自动合并所有输出<br/>map[string]any{<br/>  "summary": "...",<br/>  "questions": "...",<br/>  "key_terms": "...",<br/>  "topic": "..."<br/>}
    
    ParallelGraph-->>Main: 返回合并结果
    
    Main->>SynthesisChain: 10. 执行综合链
    SynthesisChain->>SynthesisChain: 10.1 Lambda 准备数据
    SynthesisChain->>SynthesisChain: 10.2 格式化综合提示词
    SynthesisChain->>LLM: 10.3 调用 LLM 综合答案
    Note over LLM: 基于摘要、问题、术语<br/>生成综合答案
    LLM-->>SynthesisChain: 返回综合答案
    SynthesisChain->>SynthesisChain: 10.4 Lambda 提取内容
    SynthesisChain-->>Main: 返回最终答案
    
    Main->>Output: 11. 输出最终响应
        </div>
    </div>

    <h2>执行流程说明</h2>
    
    <div class="code-block">
        <strong>阶段 1: 初始化</strong><br>
        1. 读取环境变量配置（API Key、BaseURL）<br>
        2. 初始化 LLM 模型<br>
        3. 构建三个独立链（摘要、问题、术语）<br>
        4. 创建并行图并配置节点和边<br>
        5. 构建综合链
    </div>

    <div class="code-block">
        <strong>阶段 2: 并行执行</strong><br>
        1. 用户主题传入并行图<br>
        2. 四个节点同时从 START 开始执行（真正的并行）<br>
        3. 每个节点调用对应的链，链再调用 LLM<br>
        4. 所有节点完成后，图自动合并输出（使用 WithOutputKey）<br>
        5. 返回合并后的 map[string]any 结果
    </div>

    <div class="code-block">
        <strong>阶段 3: 综合处理</strong><br>
        1. 将并行结果传递给综合链<br>
        2. Lambda 函数提取各个字段<br>
        3. 格式化综合提示词（包含摘要、问题、术语、主题）<br>
        4. 调用 LLM 生成综合答案<br>
        5. 提取并返回最终结果
    </div>

    <h2>关键组件</h2>
    
    <div class="code-block">
        <strong>并行图 (ParallelGraph)</strong><br>
        - 输入: ParallelInput{Topic: string}<br>
        - 节点: summarize, questions, terms, topic (并行执行)<br>
        - 输出: map[string]any (自动合并所有 WithOutputKey 的输出)<br>
        - 触发模式: AllPredecessor (确保所有节点完成)
    </div>

    <div class="code-block">
        <strong>三个独立链</strong><br>
        - summarizeChain: 生成主题摘要<br>
        - questionsChain: 生成相关问题<br>
        - termsChain: 提取关键术语<br>
        每个链结构: Template → ChatModel → Lambda
    </div>

    <div class="code-block">
        <strong>综合链 (SynthesisChain)</strong><br>
        - 输入: map[string]any (包含所有并行结果)<br>
        - 处理: Lambda → Template → ChatModel → Lambda<br>
        - 输出: string (综合答案)
    </div>

    <script>
        mermaid.initialize({ 
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            sequence: {
                diagramMarginX: 50,
                diagramMarginY: 10,
                actorMargin: 50,
                width: 150,
                height: 65,
                boxMargin: 10,
                boxTextMargin: 5,
                noteMargin: 10,
                messageMargin: 35
            }
        });
    </script>
</body>
</html>

